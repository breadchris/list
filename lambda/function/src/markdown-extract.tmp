}

// Handle markdown extraction
async function handleMarkdownExtract(supabase: any, payload: MarkdownExtractPayload): Promise<ContentResponse> {
  const results = [];

  for (const contentItem of payload.selectedContent) {
    try {
      const result = await processMarkdownForContent(supabase, contentItem);
      results.push(result);
    } catch (error) {
      console.error(`Error processing markdown for content ${contentItem.id}:`, error);
      results.push({
        content_id: contentItem.id,
        success: false,
        error: error.message,
        total_urls_found: 0,
        urls_processed: 0,
        markdown_children: []
      });
    }
  }

  return {
    success: true,
    data: results
  };
}

// Process markdown extraction for a single content item
async function processMarkdownForContent(supabase: any, contentItem: ContentItem) {
  // Extract URLs from content data
  const urls = extractUrls(contentItem.data);

  if (urls.length === 0) {
    return {
      content_id: contentItem.id,
      success: true,
      total_urls_found: 0,
      urls_processed: 0,
      markdown_children: []
    };
  }

  const markdownChildren: ContentItem[] = [];
  let urlsProcessed = 0;
  const errors: string[] = [];

  // Process each URL
  for (const url of urls) {
    try {
      // Fetch markdown from Cloudflare
      const markdown = await fetchMarkdownFromCloudflare(url);

      // Create markdown content as sibling (same parent as original content)
      const { data: markdownContent, error: createError } = await supabase
        .from('content')
        .insert({
          type: 'markdown',
          data: markdown,
          group_id: contentItem.group_id,
          user_id: contentItem.user_id,
          parent_content_id: contentItem.parent_content_id, // Same parent = sibling
          metadata: {
            source_url: url,
            extracted_at: new Date().toISOString(),
            cloudflare_markdown: true,
            source_content_id: contentItem.id
          }
        })
        .select()
        .single();

      if (createError) {
        console.error('Error creating markdown content:', createError);
        errors.push(`Error creating markdown content for ${url}: ${createError.message}`);
        continue;
      }

      if (markdownContent) {
        markdownChildren.push(markdownContent as ContentItem);
      }

      urlsProcessed++;

    } catch (error) {
      console.error(`Error processing URL ${url}:`, error);
      errors.push(`Error processing ${url}: ${error.message}`);
    }
  }

  return {
    content_id: contentItem.id,
    success: errors.length === 0,
    total_urls_found: urls.length,
    urls_processed: urlsProcessed,
    markdown_children: markdownChildren,
    errors: errors.length > 0 ? errors : undefined
  };
}
