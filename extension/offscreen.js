(()=>{var r=null,s=!1,o=0,i=null,c=1e3;console.log("[Offscreen] DJ Player offscreen document loaded");window.onYouTubeIframeAPIReady=()=>{console.log("[Offscreen] YouTube IFrame API ready"),r=new YT.Player("player",{height:"1",width:"1",playerVars:{autoplay:0,controls:0,mute:1,enablejsapi:1,playsinline:1,rel:0,modestbranding:1},events:{onReady:d,onStateChange:u,onError:y}})};function d(e){console.log("[Offscreen] Player ready"),s=!0,e.target.mute(),e.target.setVolume(0),chrome.runtime.sendMessage({action:"dj-player-ready"})}function u(e){if(console.log("[Offscreen] Player state changed:",{[-1]:"UNSTARTED",0:"ENDED",1:"PLAYING",2:"PAUSED",3:"BUFFERING",5:"CUED"}[e.data]||e.data),e.data===YT.PlayerState.ENDED&&(console.log("[Offscreen] Video ended, notifying service worker"),l(),chrome.runtime.sendMessage({action:"dj-video-ended",video_index:o})),e.data===YT.PlayerState.PLAYING){f();let t=r?.getDuration()||0;chrome.runtime.sendMessage({action:"dj-state-changed",is_playing:!0,duration:t})}e.data===YT.PlayerState.PAUSED&&(l(),chrome.runtime.sendMessage({action:"dj-state-changed",is_playing:!1}))}function y(e){console.error("[Offscreen] Player error:",e.data);let a={2:"Invalid video ID",5:"HTML5 player error",100:"Video not found or private",101:"Embedding not allowed",150:"Embedding not allowed"};chrome.runtime.sendMessage({action:"dj-error",error:a[e.data]||`Unknown error: ${e.data}`,error_code:e.data})}function f(){l(),i=setInterval(()=>{if(r&&s){let e=r.getCurrentTime(),a=r.getDuration();chrome.runtime.sendMessage({action:"dj-time-update",current_time:e,duration:a})}},c)}function l(){i&&(clearInterval(i),i=null)}function g(e){let a=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(let t of a){let n=e.match(t);if(n)return n[1]}return null}chrome.runtime.onMessage.addListener((e,a,t)=>{if(console.log("[Offscreen] Received message:",e.action),!r||!s){console.warn("[Offscreen] Player not ready yet"),t({success:!1,error:"Player not ready"});return}switch(e.action){case"player-load":{let n=g(e.url||e.video_id||"");if(!n){console.error("[Offscreen] Invalid video URL/ID:",e.url||e.video_id),t({success:!1,error:"Invalid video URL"});return}console.log("[Offscreen] Loading video:",n,"at",e.start_time||0),o=e.video_index??o,r.mute(),r.setVolume(0),r.loadVideoById(n,e.start_time||0),t({success:!0});break}case"player-play":console.log("[Offscreen] Playing"),r.mute(),r.playVideo(),t({success:!0});break;case"player-pause":console.log("[Offscreen] Pausing"),r.pauseVideo(),t({success:!0});break;case"player-seek":console.log("[Offscreen] Seeking to:",e.time),r.seekTo(e.time,!0),t({success:!0});break;case"player-set-rate":console.log("[Offscreen] Setting rate:",e.rate),r.setPlaybackRate(e.rate),t({success:!0});break;case"player-get-state":t({success:!0,is_playing:r.getPlayerState()===YT.PlayerState.PLAYING,current_time:r.getCurrentTime(),duration:r.getDuration(),playback_rate:r.getPlaybackRate(),video_index:o});break;case"player-stop":console.log("[Offscreen] Stopping"),l(),r.stopVideo(),t({success:!0});break;default:console.log("[Offscreen] Unknown action:",e.action),t({success:!1,error:"Unknown action"})}return!0});console.log("[Offscreen] Message listener registered");})();
