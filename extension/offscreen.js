(()=>{var t=null,c=!1,n=0,i=null,u=1e3;console.log("[Offscreen] DJ Player offscreen document loaded");window.onYouTubeIframeAPIReady=()=>{console.log("[Offscreen] YouTube IFrame API ready"),t=new YT.Player("player",{height:"1",width:"1",playerVars:{autoplay:0,controls:0,mute:1,enablejsapi:1,playsinline:1,rel:0,modestbranding:1},events:{onReady:y,onStateChange:f,onError:g}})};function y(e){console.log("[Offscreen] Player ready"),c=!0,e.target.mute(),e.target.setVolume(0),chrome.runtime.sendMessage({action:"dj-player-ready"})}function f(e){let a={[-1]:"UNSTARTED",0:"ENDED",1:"PLAYING",2:"PAUSED",3:"BUFFERING",5:"CUED"},r=t?.getDuration()||0,o=t?.getCurrentTime()||0;if(console.log(`[Offscreen] Player state changed: ${a[e.data]||e.data} | index=${n} time=${o.toFixed(1)}s/${r.toFixed(1)}s`),e.data===YT.PlayerState.ENDED&&(console.log("[Offscreen] Video ended, notifying service worker"),l(),chrome.runtime.sendMessage({action:"dj-video-ended",video_index:n})),e.data===YT.PlayerState.PLAYING){m();let d=t?.getDuration()||0;chrome.runtime.sendMessage({action:"dj-state-changed",is_playing:!0,duration:d})}e.data===YT.PlayerState.PAUSED&&(l(),chrome.runtime.sendMessage({action:"dj-state-changed",is_playing:!1}))}function g(e){console.error("[Offscreen] Player error:",e.data);let a={2:"Invalid video ID",5:"HTML5 player error",100:"Video not found or private",101:"Embedding not allowed",150:"Embedding not allowed"};chrome.runtime.sendMessage({action:"dj-error",error:a[e.data]||`Unknown error: ${e.data}`,error_code:e.data})}var s=0;function m(){l(),s=0,console.log("[Offscreen] Starting time updates"),i=setInterval(()=>{if(t&&c){let e=t.getCurrentTime(),a=t.getDuration();s++,s%5===0&&console.log(`[Offscreen] Time update: ${e.toFixed(1)}s / ${a.toFixed(1)}s (${(e/a*100).toFixed(0)}%)`),chrome.runtime.sendMessage({action:"dj-time-update",current_time:e,duration:a})}},u)}function l(){i&&(clearInterval(i),i=null)}function v(e){let a=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(let r of a){let o=e.match(r);if(o)return console.log(`[Offscreen] Extracted video ID: ${o[1]} from URL: ${e}`),o[1]}return console.warn(`[Offscreen] Could not extract video ID from: ${e}`),null}chrome.runtime.onMessage.addListener((e,a,r)=>{if(console.log("[Offscreen] Received message:",e.action),!t||!c){console.warn("[Offscreen] Player not ready yet"),r({success:!1,error:"Player not ready"});return}switch(e.action){case"player-load":{let o=v(e.url||e.video_id||"");if(!o){console.error("[Offscreen] Invalid video URL/ID:",e.url||e.video_id),r({success:!1,error:"Invalid video URL"});return}console.log("[Offscreen] Loading video:",o,"at",e.start_time||0),n=e.video_index??n,t.mute(),t.setVolume(0),t.loadVideoById(o,e.start_time||0),r({success:!0});break}case"player-play":console.log("[Offscreen] Playing"),t.mute(),t.playVideo(),r({success:!0});break;case"player-pause":console.log("[Offscreen] Pausing"),t.pauseVideo(),r({success:!0});break;case"player-seek":console.log("[Offscreen] Seeking to:",e.time),t.seekTo(e.time,!0),r({success:!0});break;case"player-set-rate":console.log("[Offscreen] Setting rate:",e.rate),t.setPlaybackRate(e.rate),r({success:!0});break;case"player-get-state":r({success:!0,is_playing:t.getPlayerState()===YT.PlayerState.PLAYING,current_time:t.getCurrentTime(),duration:t.getDuration(),playback_rate:t.getPlaybackRate(),video_index:n});break;case"player-stop":console.log("[Offscreen] Stopping"),l(),t.stopVideo(),r({success:!0});break;default:console.log("[Offscreen] Unknown action:",e.action),r({success:!1,error:"Unknown action"})}return!0});console.log("[Offscreen] Message listener registered");})();
